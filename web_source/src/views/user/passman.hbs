<link rel="stylesheet" href="/css/passman.css">
<div class="container">
    <div class="passman-title">
        Password Manager
    </div>
    <div class="tools">
        <div class="search-bar">
            <input type="text" name="search" id="search-text" placeholder="Search">
            <img src="/img/search.png" alt="search icon">
        </div>
        <div class="button-container">
            <button class="export-btn">EXPORT</button>
            <button class="create-btn">CREATE</button>
        </div>
    </div>
    <div class="table-container">
        <table class="password-table">
            <thead>
                <tr>
                    <th style="width: 5%;">STT</th>
                    <th style="width: 20%;">Mật khẩu</th>
                    <th style="width: 20%;">Ngày tạo</th>
                    <th style="width: 20%;">Thời gian</th>
                    <th style="width: 5%;">Active</th>
                    <th style="width: 15%;">Action</th>
                    <th style="width: 15%;">Detail</th>
                </tr>
            </thead>
            <tbody>
                {{!-- <tr>
                    <td>1</td>
                    <td>hallo</td>
                    <td>20/11/2003</td>
                    <td>07:00:00</td>
                    <td> <input type="checkbox"></td>
                    <td> 
                        <button class="edit-btn"></button>
                        <button class="delete-btn"></button>
                    </td>
                    <td><button>Detail</button></td>
                </tr>
                --}}
            </tbody>

        </table>
    </div>
    <div class="select-container">
        <ul class="pagination">
            {{!-- <li class="pagination-item active-item">1</li>
            <li class="pagination-item">2</li>
            <li class="pagination-item">3</li> --}}
        </ul>
        {{!-- <div class="select-bar">
            <button class="pre-btn"> &lt; </button>
            <button>1</button>
            <button>2</button>
            <button>3</button>
            <button class="next-btn"> &gt;</button>
        </div> --}}
    </div>
</div>

{{!-- Init script --}}
<script>
const tableBody = document.querySelector('.password-table tbody'); // Get Table <tbody> DOM


// Example data
const expPassList = [
    {id: "1", pass:"hallo", date:"20/11/2003", time:"07:00:00", active: true},
    {id: "2", pass:"deadline", date:"20/01/2003", time:"08:00:00",active: false},
    {id: "3", pass:"yayyy", date:"29/11/2003", time:"05:00:00",active: true},
    {id: "4", pass:"deadline", date:"20/01/2003", time:"08:00:00",active: false},
    {id: "5", pass:"yayyy", date:"29/11/2003", time:"05:00:00",active: true},
    {id: "6", pass:"deadline", date:"20/01/2003", time:"08:00:00",active: false},
    {id: "7", pass:"yayyy", date:"29/11/2003", time:"05:00:00",active: true},
    {id: "8", pass:"deadline", date:"20/01/2003", time:"08:00:00",active: false},
    {id: "9", pass:"yayyy", date:"29/11/2003", time:"05:00:00",active: true},
    {id: "10", pass:"yayyy", date:"29/11/2003", time:"05:00:00",active: true},
    {id: "11", pass:"deadline", date:"20/01/2003", time:"08:00:00",active: false},
    {id: "12", pass:"yayyy", date:"29/11/2003", time:"05:00:00",active: true},
    {id: "13", pass:"deadline", date:"20/01/2003", time:"08:00:00",active: false},
    {id: "14", pass:"yayyy", date:"29/11/2003", time:"05:00:00",active: true},
]


// Get Password List
async function fetchData(){
    const res = await fetch("http://localhost:3000/passman/getPass",{method:'GET'})
    console.log(res.json());
}

fetchData();

function getPassList(){

    return expPassList;
}

//  Handle DetailButton onClick
function handleDetailBtnClick(id){
    // Set Cookie openPasswordID to passinfo
    document.cookie = "openPasswordID="+id;
    // Go to PassInfo
    window.location.assign("/passinfo");
}


//
const PASSLIST = getPassList();
let passList = PASSLIST;
let currentPage = 1;
const perPage = 5;
let totalPage = Math.ceil(passList.length / perPage);
const maxDisplayPagination = 5;

// Display all password in table
function displayPasswordTable(){
    tableBody.innerHTML = "";
    //
    const beginIndex = perPage * (currentPage - 1);
    const endIndex = beginIndex + perPage - 1;
    displayList = passList.slice(beginIndex , endIndex + 1);
    //
    displayList.forEach(function(pass){
        const tableHolder = `
                <td>${pass['id']}</td>
                <td>${pass['pass']}</td>
                <td>${pass['date']}</td>
                <td>${pass['time']}</td>
                <td> <input type="checkbox" onclick="return false;" ${pass['active']?"checked":""}></td>
                <td> 
                    <button class="edit-btn"></button>
                    <button class="delete-btn"></button>
                </td>
                <td><button onclick="handleDetailBtnClick(${pass['id']})">Detail</button></td>
        `;
        //console.log(tableHolder);
        tableBody.innerHTML += tableHolder;
    });
}



</script>

{{!-- Pagination --}}
<script>
    const pagination = document.querySelector('.pagination');
    //

    function displayPagination(){
        pagination.innerHTML = "";
        pagination.innerHTML += `<li class="pagination-item" onclick="handlePaginationPress(-2)">\<\<</li>`;
        if (totalPage == 0){
            pagination.innerHTML += `<li class="pagination-item active-item" >0</li>`;
        }
        else if (totalPage <= maxDisplayPagination){
            for(let i = 1; i <= totalPage;  i++){
                if (i == currentPage){
                    pagination.innerHTML += `<li class="pagination-item active-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                }
                else{
                    pagination.innerHTML += `<li class="pagination-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                }
            }
        }
        else {
            if (currentPage <  3 ){
                for(let i = 1; i <= maxDisplayPagination;  i++){
                    if (i == currentPage){
                        pagination.innerHTML += `<li class="pagination-item active-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                    }
                    else{
                        pagination.innerHTML += `<li class="pagination-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                    }
                }
            }
            else if (currentPage > totalPage - 2){
                    for(let i = totalPage - maxDisplayPagination + 1 ; i <= totalPage;  i++){
                        if (i == currentPage){
                            pagination.innerHTML += `<li class="pagination-item active-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                        }
                        else{
                            pagination.innerHTML += `<li class="pagination-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                    }
                }
            }
            else{
                for(let i = currentPage - 2  ; i <= currentPage + 2;  i++){
                    if (i == currentPage){
                        pagination.innerHTML += `<li class="pagination-item active-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                    }
                    else{
                        pagination.innerHTML += `<li class="pagination-item" onclick="handlePaginationPress(${i})">${i}</li>`;
                    }
                }                
            }
        }

        pagination.innerHTML += `
            <li class="pagination-item last-item" onclick="handlePaginationPress(-1)">\>\></li>
        `;
    }

    function handlePaginationPress(i){
        // -2: first item
        // -1: last item
        if (i == -2){
            currentPage = 1;
        }
        else if ( i == -1){
            currentPage = totalPage;
        }
        else{
            currentPage = i;
        }

        displayPagination();
        displayPasswordTable();
    }
</script>

{{!-- Script for search --}}
<script>

    function filter(filterText, value){
        if (filter == "") return true;
        return value.includes(filterText);
    }

    //Handle search onChange
    document.querySelector("#search-text").addEventListener('keydown',function(event){
        if (event.key === 'Enter'){
            const filterText = this.value;
            passList = PASSLIST.filter((pass)=>filter(filterText,pass['pass']));
            currentPage = 1;
            totalPage = Math.ceil(passList.length / perPage);
            displayPagination();
            displayPasswordTable();
        }
    });
</script>


{{!-- Main script --}}
<script>
    displayPagination();
    displayPasswordTable();
    
</script>